model Profile {
  @@schema("user_management")
  uuid                  String             @id @default(uuid())
  email                 String             @unique
  phone_number          String?            @unique
  username              String?            @unique
  password_hash         String
  first_name            String
  last_name             String
  profile_picture       String?
  gender                String?
  date_of_birth         DateTime?
  language              String             @default("en")
  timezone              String             @default("UTC")
  status                String             @default("active")
  email_verified        Boolean            @default(false)
  phone_verified        Boolean            @default(false)
  last_login_at         DateTime?
  failed_login_attempts Int                @default(0)
  last_failed_login_at  DateTime?
  created_at            DateTime           @default(now())
  updated_at            DateTime           @updatedAt
  deleted_at            DateTime?
  user_permissions      UserPermission[]
  roles                 UserRole[]
  user_sessions         UserSession[]
  verifications         UserVerification[]

  @@index([uuid])
  @@index([email])
  @@index([status])
  @@index([username])
}

model UserPermission {
  @@schema("user_management")
  id            Int        @id @default(autoincrement())
  userId        String
  permission_id Int
  granted_at    DateTime   @default(now())
  permission    Permission @relation(fields: [permission_id], references: [id])
  user          Profile    @relation(fields: [userId], references: [uuid])
}

model UserRole {
  @@schema("user_management")
  id          Int      @id @default(autoincrement())
  assigned_at DateTime @default(now())
  role_id     Int
  userId      String
  role        Role     @relation(fields: [role_id], references: [id])
  user        Profile  @relation(fields: [userId], references: [uuid])
}

model Role {
  @@schema("user_management")
  id              Int              @id @default(autoincrement())
  name            String           @unique
  description     String?
  level           Int              @default(10)
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt
  organization_id Int?
  permissions     RolePermission[]
  users           UserRole[]
}

model Permission {
  @@schema("user_management")
  id               Int              @id @default(autoincrement())
  name             String           @unique
  module           String
  action           String
  description      String?
  created_at       DateTime         @default(now())
  updated_at       DateTime         @updatedAt
  role_permissions RolePermission[]
  user_permissions UserPermission[]

  @@unique([module, action])
}

model RolePermission {
  @@schema("user_management")
  id            Int        @id @default(autoincrement())
  permission_id Int
  role_id       Int
  permission    Permission @relation(fields: [permission_id], references: [id])
  role          Role       @relation(fields: [role_id], references: [id])
}

model UserVerification {
  @@schema("user_management")
  uvid             String           @id @default(uuid())
  userId           String
  verificationType String // EMAIL or PHONE
  method           String // OTP or TOKEN
  identifier       String // Email or phone number

  code      String // Can be OTP or token
  expiresAt DateTime // Expiry for OTP or token

  isVerified Boolean @default(false)
  attempts   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user Profile @relation(fields: [userId], references: [uuid])

  @@index([userId, verificationType, identifier])
  @@index([code])
}

model UserSession {
  @@schema("user_management")
  id           Int       @id @default(autoincrement())
  userId       String
  refreshToken String    @unique
  device       String?
  browser      String?
  ipAddress    String?
  location     String?
  isActive     Boolean   @default(true)
  loggedInAt   DateTime  @default(now())
  loggedOutAt  DateTime?
  expiresAt    DateTime
  user         Profile   @relation(fields: [userId], references: [uuid])

  @@index([userId])
}

model BlacklistedToken {
  @@schema("user_management")
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([expiresAt])
}

